<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Board</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <h1>RODADA:</h1><h1 id="rodada"></h1>
  <h1>LETRA:</h1><h1 id="letra"></h1>

  <table>
      <tr>
          <td id="tema1"></td>
          <td id="tema2"></td>
          <td id="tema3"></td>
          <td id="tema4"></td>
      </tr>
      <tr>
          <td>
              <input type="text" name="palavra1" id="palavra1">
          </td>
          <td>
            <input type="text" name="palavra2" id="palavra2">
        </td>
          <td>
              <input type="text" name="palavra3" id="palavra3">
          </td>
          <td>
              <input type="text" name="palavra4" id="palavra4">
          </td>
      </tr>
  </table>
      

  <p onclick="gritaStop()" style="
  padding: 7px;
    border-radius: 7px;
    border: 1px solid black;
    display: inline;
    cursor: pointer;
    position: absolute;
    top: 0;
    right: 30px;
  "> GRITAR STOP</p>
  
  <div id="pontuacao"></div>
  
  <script>
    var dados;
    var urlParams = new URLSearchParams(location.search);
    var partidaId = urlParams.get('partidaId');
    var usuario = urlParams.get('usuario');

    function gritaStop() {
      var request = new XMLHttpRequest();
      request.onreadystatechange = (status, readyState) => {
          if(request.status === 200 && request.readyState === 4) {
              // atualizaPontuacao(JSON.parse(request.responseText));
          }
      }
      request.open('GET', 'http://localhost:3001/v1/users/stop?partidaId=' + partidaId);
      request.send();
    }

    setInterval(() => {
        var request = new XMLHttpRequest();
        request.onreadystatechange = (status, readyState) => {
            if(request.status === 200 && request.readyState === 4) {
                atualizaPontuacao(JSON.parse(request.responseText));
            }
        }
        request.open('GET', 'http://localhost:3001/v1/users/pontos?partidaId=' + partidaId);
        request.send();
    }, 1000);

    setTimeout(() => {
      var request = new XMLHttpRequest();
      request.onreadystatechange = (status, readyState) => {
          if(request.status === 200 && request.readyState === 4) {
              atualizaTemas(JSON.parse(request.responseText));
          }
        }
        request.open('GET', 'http://localhost:3001/v1/users/temas?partidaId=' + partidaId);
        request.send();
    }, 1000);

      function atualizaPontuacao(request) {
          pontuacao = document.getElementById('pontuacao');
          pontuacao.innerHTML = '';
          for (const key in request.data) {
              var p = document.createElement('p');
              p.innerHTML = key + ': ' + request.data[key] + ' pontos';
              pontuacao.appendChild(p);
          }
          console.log('PONTUACAO', request);
      }
      
      
      function atualizaPartida(request) {
          console.log('Temos', request);
          rodada = request.data.rodada;
          rodadaText.innerHTML = rodada;
          letra = request.data[`letra${rodada}`];
          letraText.innerHTML = letra;
      }

      function atualizaTemas(request) {
          console.log('ddddd', request);
          document.getElementById('tema1').innerHTML=request.data.tema1;
          document.getElementById('tema2').innerHTML=request.data.tema2;
          document.getElementById('tema3').innerHTML=request.data.tema3;
          document.getElementById('tema4').innerHTML=request.data.tema4;
      }
      var rodadaText = document.getElementById('rodada');
      var letraText = document.getElementById('letra');
      // var usuario = 'request' + (new Date()).getTime();
      var palavra1 = document.getElementById('palavra1');
      var palavra2 = document.getElementById('palavra2');
      var palavra3 = document.getElementById('palavra3');
      var palavra4 = document.getElementById('palavra4');
      var rodada = 1;
      var letra = '';

      setInterval(() => {
          var request2 = new XMLHttpRequest();
          request2.onreadystatechange = (status, readyState) => {
              if(request2.status === 200 && request2.readyState === 4) {
                  atualizaPartida(JSON.parse(request2.responseText));
              }
          }
          request2.open('POST', 'http://localhost:3001/v1/users/status-partida', true);
          request2.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
          request2.send(`partidaId=${partidaId}&usuarioId=${usuario}&palavra1=${palavra1.value}&palavra2=${palavra2.value}&palavra3=${palavra3.value}&palavra4=${palavra4.value}&rodada=${rodada}`);
      }, 1000);
  </script>
</body>
</html>